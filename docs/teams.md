# Teams
MS Teams uses the MS Graph API  
We Authenticate with Azure to get a token  
With the token, we can send messages directly to teams chats (one-on-one or groups)
We also subscribe to chat 'resources', This is so we get notified of new messages in a chat


&nbsp;<br>
## Sending Messages to Teams
    To send chat messages to teams from the chatbot, we must first be authenticated. See ms-identity.txt to understand this process  
    There is a simple function called send_chat() which will send a message to the Graph API, along with the bearer token  
    
## Talking to the Chatbot
    Users can send messages to the chatbot. This requires us to subscribe to 'change notifications' for the resource (chat or group)
    When someone writes to the chat, the chatbot will get a notification via webhook
    The subscription contains a callback URL that the webhook should be sent to
    When subscribing, GraphAPI will send authentication information to the callback URL to authenticate the subscription
    These subscriptions can be for specific chats, or it can be for all chat messages sent to the teams user
        Configure this using the teams/sub_all option in config.yaml
        NOTE: MS charges for the use of subscribing to all chats, although this is not expensive (500 messages per month is free on the eval license)
        Subscribing to individual chats is included in the teams user license
    
### Subscription Refresh
    Subscriptions are valid for up to an hour
      We select a duration while subscribing
    Before this expires, we need to request an extention
    This is done by sending a PATCH message to the API with a new renewal time

### Encrypted Webhooks - Messages from Teams
    The webhook contains the contents of the message in an encrypted format
    During the subscription process, we pass a public key to Graph API
      Message contents are encrypted with this public key
      We can decrypt the messages with our private key
    MS will create a session key and encrypt the message with that
      The session key is different for each message
    The session key is encrypted with our public key


&nbsp;<br>
## Generating Public/Private Key Pair
    A key pair can be generated by using OpenSSL.
    This is required to receive messages from Teams (messages must be encrypted)

### Windows
    Install one of the packages from:
        https://slproweb.com/products/Win32OpenSSL.html
        
### Key Generation
    Generate a private key (should be 2048-bit or larger)
        openssl genrsa -out private.key 2048
        
    Generate the public key
        openssl req -new -x509 -key private.key -out publickey.pem -days 365
  


&nbsp;<br>
- - - -
## teamschat.py
### check_token()
    Confirms that we are authenticated with Graph API
    Reads the token from token.txt, and returns it

        Parameters:
            None

        Raises:
            Exception
                If token.txt can't be opened

        Returns:
            full_token : str
                The full token, as given to us from Graph API
            False : Boolean
                Returned if there was a problem
    
### send_chat()
    Takes a message, and sends it to a teams chat
    Requires that a bearer token has already been allocated,
    and saved in token.txt

        Parameters:
            message : str
                An HTML formatted string that is sent to Teams
            chat_msg_id : str
                The chat ID to send the message to

        Raises:
            Exception
                If there was an error connecting to the API

        Returns:
            chat_id : str
                An ID returned from Graph that represents this message
            False : Boolean
                Returned if there was a problem
        
### notification_refresh()
    Subscribes for notifications to a chats. This can be all chats or a list.
    The 'sub_all' option in the global config file determines this bahaviour.
    Schedules a thread to refresh this before they expire

        Parameters:
            None

        Returns:
            None
                
### ChatSubscribe
    Subscribe to Teams chat IDs to get notified of new chats
    Threaded for better performance
    This class is instantiated for each resource being subscribed to

    Attributes
    ----------
    threading.Thread
        Inherited thread class, enabling each instance to be threaded
        
    Methods
    -------
    token()
        Gets the Graph API token
    public_key()
        Retrieves our public key
    get_sub()
        Check if this is an active subscription
    new_sub()
        Create a new subscription
    refresh_sub()
        Refresh an existing subscription
    expiry_time()
        Get an expiry time for a subscription
        

&nbsp;<br>
- - - -
## crypto.py
    The private key should be a file named 'private.pem', which should be kept in the core folder
    The public key should be a file named 'public.pem', which should be kept in the core folder

### rsa_decrypt()
    Arguments: 
        encrypted_symmetric_key
    Returns:
        decrypted_symmetric_key
    Purpose:
        Takes a symmetric key (encrypted) as it appears in the webhook
        Uses the private key to decrypt it
    
### validate()
    Arguments: 
        decrypted_symmetric_key
        data
        signature
    Returns:
        True or False
    Purpose:
        Creates a hash of the body of the webhook, using the symmetric key and HMAC-SHA-256
        Compare the result to the signature contained in the webhook
        Returns True if there is a match (a valid webhook)
    
### aes_decrypt()
    Arguments: 
        decrypted_symmetric_key
        data
    Returns:
        decrypted_payload
    Purpose:
        Uses the symmetric key to decrypt the message in the webhook


&nbsp;<br>
- - - -
## parse_chats.py
    Parses messages sent to the chatbot, so it can respond
    This has only basic functionality at this time (eg, say 'hi' or 'tell me a joke')
    Can accept chats from groups of individuals, if they're authorized

### parse()
    Arguments:
        message
        sender
    Returns:
        none
    Purpose:
        Checks if the message sender is the chatbot itself (it shouldn't reply to itself after all)
        Checks if the message is a known value (eg, 'hi' or 'tell me a joke') and responds
        If the message is anything else, it plays the message back to the sender
        
### tell_joke()
    Arguments: 'chat_id' - The ID of the chat to send to
    Returns: none
    Purpose:
        NLP Testing
        Selects a random joke from a list and sends it

### greeting()
    Arguments: 'chat_id' - The ID of the chat to send to
    Returns: none
    Purpose:
        NLP Testing
        Send a general greeting to the user

### get_weather()
    Arguments: 'chat_id' - The ID of the chat to send to
    Returns: none
    Purpose:
        NLP Testing
        Send a message about the weather

### are_you_human()
    Arguments: 'chat_id' - The ID of the chat to send to
    Returns: none
    Purpose:
        NLP testing
        Send a message about being AI

### day_time()
    Arguments: 'chat_id' - The ID of the chat to send to
    Returns: none
    Purpose:
        NLP Testing
        Send a message about the time and day


&nbsp;<br>
- - - -
## chat_id.py
    Get a list of chats, and corresponding names, that the chatbot knows about

### get_chats()
    Arguments: none
    Returns: A list of known chats and names
    Purpose: 
        Sends an API call to Graph, to get a list of chats
        Colate a list of chat IDs, group names, and members into a table
        Return this as a list of dictionaries
    
    
    
&nbsp;<br>
- - - -
## smtp.py
    Used to alert someone if there's problems sending over teams  
    This is not intended to be used for regular notifications  

### send_mail()
    Arguments: message - The message that should be converted to an email  
    Returns: None  
    Purpose: 
        Takes a message, and converts it to MIMEText. Then sends email using the details in config.yaml  



